<!-- Welcome Screen - No file open -->
@if (!mbox.isFileOpen()) {
  <div class="welcome-screen">
    <div class="welcome-content">
      <div class="welcome-icon">
        <app-icon name="mail" [size]="80" [strokeWidth]="1.5" />
      </div>
      <h1>MBOX Viewer</h1>
      <p>Open Gmail Takeout exports and other MBOX files</p>
      
      @if (mbox.loadingFile()) {
        <div class="loading-indicator">
          <app-spinner />
          <span>Loading...</span>
        </div>
      } @else {
        <button class="btn-primary" (click)="onOpenFile()">
          Open MBOX File
        </button>
        
        @if (mbox.recentFiles().length > 0) {
          <div class="recent-files">
            <h3>Recent Files</h3>
            <ul class="recent-files-list">
              @for (file of mbox.recentFiles(); track file.path) {
                <li class="recent-file-item">
                  <button class="recent-file-btn" (click)="onOpenRecentFile(file.path)">
                    <app-icon name="mail" />
                    <span class="recent-file-name">{{ file.name }}</span>
                    <span class="recent-file-date">{{ formatRecentDate(file.lastOpened) }}</span>
                  </button>
                  <button class="recent-file-remove" (click)="onRemoveRecentFile(file.path, $event)" title="Remove from list">
                    <app-icon name="close" [size]="14" />
                  </button>
                </li>
              }
            </ul>
          </div>
        }
      }
    </div>
  </div>
}

<!-- Main App Layout -->
@if (mbox.isFileOpen()) {
  <div class="app-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <button class="btn-icon" (click)="onOpenFile()" title="Open another file">
          <app-icon name="folder" [size]="18" />
        </button>
        <span class="file-name" [title]="mbox.currentPath()">{{ getFileName(mbox.currentPath()) }}</span>
        <button class="btn-icon" (click)="onCloseFile()" title="Close file">
          <app-icon name="close" [size]="18" />
        </button>
      </div>

      <div class="sidebar-stats">
        <div class="stat">
          <span class="stat-value">{{ mbox.stats()?.total_messages | number }}</span>
          <span class="stat-label">emails</span>
        </div>
        <div class="stat">
          <span class="stat-value">{{ mbox.stats()?.total_with_attachments | number }}</span>
          <span class="stat-label">with attachments</span>
        </div>
      </div>

      <nav class="sidebar-nav">
        <button 
          class="nav-item" 
          [class.active]="!mbox.selectedLabel() && !mbox.searchQuery()"
          (click)="onLabelClick(null)">
          <app-icon name="activity" />
          All Mail
          <span class="nav-count">{{ mbox.stats()?.total_messages | number }}</span>
        </button>

        @for (label of mbox.labels(); track label.label) {
          <button 
            class="nav-item"
            [class.active]="mbox.selectedLabel() === label.label"
            (click)="onLabelClick(label.label)">
            <app-icon name="tag" />
            {{ label.label }}
            <span class="nav-count">{{ label.count | number }}</span>
          </button>
        }
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Toolbar -->
      <div class="toolbar">
        <div class="search-box" [class.searching]="mbox.isSearching()">
          @if (mbox.isSearching()) {
            <app-spinner [size]="18" />
          } @else {
            <app-icon name="search" [size]="18" />
          }
          <input 
            #searchInput
            type="text" 
            placeholder="Search emails... (from:user subject:test date:2024)" 
            [value]="searchValue"
            (input)="onSearchInput(searchInput.value)">
          @if (searchValue) {
            <button class="btn-clear" (click)="onClearSearch()">
              <app-icon name="close" />
            </button>
          }
        </div>
        @let resultsCount = mbox.searchResultsCount();
        @if (searchValue && resultsCount !== null) {
          <span class="search-results-count">
            @if (resultsCount > mbox.emails().length) {
              {{ mbox.emails().length }} of {{ resultsCount }} results
            } @else {
              {{ resultsCount }} results
            }
          </span>
        }
      </div>

      <!-- Content Area -->
      <div class="content-area">
        <!-- Email List -->
        <div class="email-list" [class.has-selection]="mbox.selectedEmail()">
          @if (mbox.searchQuery()) {
            <div class="list-header">
              Search results for "{{ mbox.searchQuery() }}" ({{ mbox.emails().length }} found)
            </div>
          }
          @if (mbox.selectedLabel()) {
            <div class="list-header">
              {{ mbox.selectedLabel() }} ({{ mbox.emails().length }} emails)
            </div>
          }

          @if ((mbox.loadingFile() || mbox.loadingEmails()) && mbox.emails().length === 0) {
            <div class="loading-state">
              <app-spinner />
              Loading emails...
            </div>
          }

          @for (email of mbox.emails(); track email.index) {
            <div 
              class="email-item" 
              [class.selected]="mbox.selectedEmail()?.index === email.index"
              [class.has-attachment]="email.has_attachments"
              role="button"
              tabindex="0"
              (click)="onEmailClick(email)"
              (keydown.enter)="onEmailClick(email)">
              <div class="email-sender">{{ formatSender(email) }}</div>
              <div class="email-subject">
                @if (email.has_attachments) {
                  <app-icon name="attachment" [size]="14" class="attachment-icon" />
                }
                {{ email.subject || '(No subject)' }}
              </div>
              <div class="email-date">{{ formatDate(email.date) }}</div>
              @if (email.labels.length > 0) {
                <div class="email-labels">
                  @for (label of email.labels.slice(0, 3); track label) {
                    <span class="label-tag">{{ label }}</span>
                  }
                  @if (email.labels.length > 3) {
                    <span class="label-more">+{{ email.labels.length - 3 }}</span>
                  }
                </div>
              }
            </div>
          }

          @if (!mbox.loadingFile() && !mbox.loadingEmails() && mbox.emails().length === 0) {
            <div class="empty-state">
              <app-icon name="mail" [size]="48" [strokeWidth]="1.5" />
              <p>No emails found</p>
            </div>
          }
        </div>

        <!-- Email Detail -->
        @let email = mbox.selectedEmail();
        @if (email) {
          <div class="email-detail">
            <div class="detail-header">
              <button class="btn-back" (click)="onCloseEmail()">
                <app-icon name="arrow-left" [size]="20" />
                Back
              </button>
            </div>

            <div class="detail-content">
              <h2 class="detail-subject">{{ email.subject || '(No subject)' }}</h2>
              
              <div class="detail-meta">
                <div class="meta-row">
                  <span class="meta-label">From:</span>
                  <span class="meta-value">
                    @if (email.from_name) {
                      {{ email.from_name }} &lt;{{ email.from_address }}&gt;
                    } @else {
                      {{ email.from_address }}
                    }
                  </span>
                </div>
                @if (email.to.length > 0) {
                  <div class="meta-row">
                    <span class="meta-label">To:</span>
                    <span class="meta-value">
                      @for (to of email.to; track to.address; let last = $last) {
                        @if (to.name) {
                          {{ to.name }} &lt;{{ to.address }}&gt;
                        } @else {
                          {{ to.address }}
                        }
                        @if (!last) {, }
                      }
                    </span>
                  </div>
                }
                <div class="meta-row">
                  <span class="meta-label">Date:</span>
                  <span class="meta-value">{{ formatDate(email.date) }}</span>
                </div>
                @if (email.labels.length > 0) {
                  <div class="meta-row">
                    <span class="meta-label">Labels:</span>
                    <span class="meta-value labels">
                      @for (label of email.labels; track label) {
                        <span class="label-tag">{{ label }}</span>
                      }
                    </span>
                  </div>
                }
              </div>

              <!-- Attachments -->
              @let body = mbox.selectedEmailBody();
              @if (body && body.attachments.length > 0) {
                <div class="attachments-section">
                  <h3>
                    <app-icon name="attachment" />
                    Attachments ({{ body.attachments.length }})
                  </h3>
                  <div class="attachments-list">
                    @for (attachment of body.attachments; track attachment.part_index) {
                      <button class="attachment-item" (click)="onDownloadAttachment(attachment)">
                        <app-icon name="file" [size]="20" />
                        <div class="attachment-info">
                          <span class="attachment-name">{{ attachment.filename }}</span>
                          <span class="attachment-size">{{ formatFileSize(attachment.size) }}</span>
                        </div>
                        <app-icon name="download" class="download-icon" />
                      </button>
                    }
                  </div>
                </div>
              }

              <!-- Email Body -->
              <div class="email-body">
                @if (mbox.loadingEmailBody() && !body) {
                  <div class="loading-state">
                    <app-spinner />
                    Loading email content...
                  </div>
                } @else if (body) {
                  @if (body.html) {
                    <iframe 
                      class="email-iframe"
                      [srcdoc]="body.html"
                      sandbox="allow-same-origin">
                    </iframe>
                  } @else if (body.text) {
                    <pre class="email-text">{{ body.text }}</pre>
                  } @else {
                    <div class="empty-body">
                      <p>No content available</p>
                    </div>
                  }
                } @else {
                  <div class="empty-body">
                    <p>No content available</p>
                  </div>
                }
              </div>
            </div>
          </div>
        }
      </div>
    </main>
  </div>
}

<!-- Error Toast -->
<app-error-toast [message]="mbox.error()" (dismissed)="onDismissError()" />
