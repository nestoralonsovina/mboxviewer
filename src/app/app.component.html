<!-- Welcome Screen - No file open -->
@if (!mbox.isFileOpen()) {
  <app-welcome
    [recentFiles]="mbox.recentFiles()"
    [isLoading]="mbox.loadingFile()"
    (openFile)="onOpenFile()"
    (openRecent)="onOpenRecentFile($event)"
    (removeRecent)="onRemoveRecentFile($event)" />
}

<!-- Main App Layout -->
@if (mbox.isFileOpen()) {
  <div class="app-layout">
    <!-- Sidebar -->
    <app-sidebar
      [stats]="mbox.stats()"
      [labels]="mbox.labels()"
      [selectedLabel]="mbox.selectedLabel()"
      [searchQuery]="mbox.searchQuery()"
      [currentPath]="mbox.currentPath()"
      (openFile)="onOpenFile()"
      (closeFile)="onCloseFile()"
      (labelClick)="onLabelClick($event)" />

    <!-- Main Content -->
    <main class="main-content">
      <!-- Toolbar -->
      <app-search-toolbar
        [isSearching]="mbox.isSearching()"
        [searchResultsCount]="mbox.searchResultsCount()"
        [emailCount]="mbox.emails().length"
        (searchChange)="onSearchInput($event)"
        (clearSearch)="onClearSearch()" />

      <!-- Content Area -->
      <div class="content-area">
        <!-- Email List -->
        <div class="email-list" [class.has-selection]="mbox.selectedEmail()">
          @if (mbox.searchQuery()) {
            <div class="list-header">
              Search results for "{{ mbox.searchQuery() }}" ({{ mbox.emails().length }} found)
            </div>
          }
          @if (mbox.selectedLabel()) {
            <div class="list-header">
              {{ mbox.selectedLabel() }} ({{ mbox.emails().length }} emails)
            </div>
          }

          @if ((mbox.loadingFile() || mbox.loadingEmails()) && mbox.emails().length === 0) {
            <div class="loading-state">
              <app-spinner />
              Loading emails...
            </div>
          }

          @for (email of mbox.emails(); track email.index) {
            <div 
              class="email-item" 
              [class.selected]="mbox.selectedEmail()?.index === email.index"
              [class.has-attachment]="email.has_attachments"
              role="button"
              tabindex="0"
              (click)="onEmailClick(email)"
              (keydown.enter)="onEmailClick(email)">
              <div class="email-sender">{{ formatSender(email) }}</div>
              <div class="email-subject">
                @if (email.has_attachments) {
                  <app-icon name="attachment" [size]="14" class="attachment-icon" />
                }
                {{ email.subject || '(No subject)' }}
              </div>
              <div class="email-date">{{ formatDate(email.date) }}</div>
              @if (email.labels.length > 0) {
                <div class="email-labels">
                  @for (label of email.labels.slice(0, 3); track label) {
                    <span class="label-tag">{{ label }}</span>
                  }
                  @if (email.labels.length > 3) {
                    <span class="label-more">+{{ email.labels.length - 3 }}</span>
                  }
                </div>
              }
            </div>
          }

          @if (!mbox.loadingFile() && !mbox.loadingEmails() && mbox.emails().length === 0) {
            <div class="empty-state">
              <app-icon name="mail" [size]="48" [strokeWidth]="1.5" />
              <p>No emails found</p>
            </div>
          }
        </div>

        <!-- Email Detail -->
        @let email = mbox.selectedEmail();
        @if (email) {
          <div class="email-detail">
            <div class="detail-header">
              <button class="btn-back" (click)="onCloseEmail()">
                <app-icon name="arrow-left" [size]="20" />
                Back
              </button>
            </div>

            <div class="detail-content">
              <h2 class="detail-subject">{{ email.subject || '(No subject)' }}</h2>
              
              <div class="detail-meta">
                <div class="meta-row">
                  <span class="meta-label">From:</span>
                  <span class="meta-value">
                    @if (email.from_name) {
                      {{ email.from_name }} &lt;{{ email.from_address }}&gt;
                    } @else {
                      {{ email.from_address }}
                    }
                  </span>
                </div>
                @if (email.to.length > 0) {
                  <div class="meta-row">
                    <span class="meta-label">To:</span>
                    <span class="meta-value">
                      @for (to of email.to; track to.address; let last = $last) {
                        @if (to.name) {
                          {{ to.name }} &lt;{{ to.address }}&gt;
                        } @else {
                          {{ to.address }}
                        }
                        @if (!last) {, }
                      }
                    </span>
                  </div>
                }
                <div class="meta-row">
                  <span class="meta-label">Date:</span>
                  <span class="meta-value">{{ formatDate(email.date) }}</span>
                </div>
                @if (email.labels.length > 0) {
                  <div class="meta-row">
                    <span class="meta-label">Labels:</span>
                    <span class="meta-value labels">
                      @for (label of email.labels; track label) {
                        <span class="label-tag">{{ label }}</span>
                      }
                    </span>
                  </div>
                }
              </div>

              <!-- Attachments -->
              @let body = mbox.selectedEmailBody();
              @if (body && body.attachments.length > 0) {
                <div class="attachments-section">
                  <h3>
                    <app-icon name="attachment" />
                    Attachments ({{ body.attachments.length }})
                  </h3>
                  <div class="attachments-list">
                    @for (attachment of body.attachments; track attachment.part_index) {
                      <button class="attachment-item" (click)="onDownloadAttachment(attachment)">
                        <app-icon name="file" [size]="20" />
                        <div class="attachment-info">
                          <span class="attachment-name">{{ attachment.filename }}</span>
                          <span class="attachment-size">{{ formatFileSize(attachment.size) }}</span>
                        </div>
                        <app-icon name="download" class="download-icon" />
                      </button>
                    }
                  </div>
                </div>
              }

              <!-- Email Body -->
              <div class="email-body">
                @if (mbox.loadingEmailBody() && !body) {
                  <div class="loading-state">
                    <app-spinner />
                    Loading email content...
                  </div>
                } @else if (body) {
                  @if (body.html) {
                    <iframe 
                      class="email-iframe"
                      [srcdoc]="body.html"
                      sandbox="allow-same-origin">
                    </iframe>
                  } @else if (body.text) {
                    <pre class="email-text">{{ body.text }}</pre>
                  } @else {
                    <div class="empty-body">
                      <p>No content available</p>
                    </div>
                  }
                } @else {
                  <div class="empty-body">
                    <p>No content available</p>
                  </div>
                }
              </div>
            </div>
          </div>
        }
      </div>
    </main>
  </div>
}

<!-- Error Toast -->
<app-error-toast [message]="mbox.error()" (dismissed)="onDismissError()" />
