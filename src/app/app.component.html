<!-- Welcome Screen - No file open -->
@if (!mbox.isFileOpen()) {
  <div class="welcome-screen">
    <div class="welcome-content">
      <div class="welcome-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
          <polyline points="22,6 12,13 2,6"/>
        </svg>
      </div>
      <h1>MBOX Viewer</h1>
      <p>Open Gmail Takeout exports and other MBOX files</p>
      
      @if (mbox.loadingFile()) {
        <div class="loading-indicator">
          <span class="spinner"></span>
          <span>Loading...</span>
        </div>
      } @else {
        <button class="btn-primary" (click)="onOpenFile()">
          Open MBOX File
        </button>
        
        @if (mbox.recentFiles().length > 0) {
          <div class="recent-files">
            <h3>Recent Files</h3>
            <ul class="recent-files-list">
              @for (file of mbox.recentFiles(); track file.path) {
                <li class="recent-file-item">
                  <button class="recent-file-btn" (click)="onOpenRecentFile(file.path)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                      <polyline points="22,6 12,13 2,6"/>
                    </svg>
                    <span class="recent-file-name">{{ file.name }}</span>
                    <span class="recent-file-date">{{ formatRecentDate(file.lastOpened) }}</span>
                  </button>
                  <button class="recent-file-remove" (click)="onRemoveRecentFile(file.path, $event)" title="Remove from list">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <line x1="18" y1="6" x2="6" y2="18"/>
                      <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                  </button>
                </li>
              }
            </ul>
          </div>
        }
      }
    </div>
  </div>
}

<!-- Main App Layout -->
@if (mbox.isFileOpen()) {
  <div class="app-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <button class="btn-icon" (click)="onOpenFile()" title="Open another file">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
          </svg>
        </button>
        <span class="file-name" [title]="mbox.currentPath()">{{ getFileName(mbox.currentPath()) }}</span>
        <button class="btn-icon" (click)="onCloseFile()" title="Close file">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>

      <div class="sidebar-stats">
        <div class="stat">
          <span class="stat-value">{{ mbox.stats()?.total_messages | number }}</span>
          <span class="stat-label">emails</span>
        </div>
        <div class="stat">
          <span class="stat-value">{{ mbox.stats()?.total_with_attachments | number }}</span>
          <span class="stat-label">with attachments</span>
        </div>
      </div>

      <nav class="sidebar-nav">
        <button 
          class="nav-item" 
          [class.active]="!mbox.selectedLabel() && !mbox.searchQuery()"
          (click)="onLabelClick(null)">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
          </svg>
          All Mail
          <span class="nav-count">{{ mbox.stats()?.total_messages | number }}</span>
        </button>

        @for (label of mbox.labels(); track label.label) {
          <button 
            class="nav-item"
            [class.active]="mbox.selectedLabel() === label.label"
            (click)="onLabelClick(label.label)">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/>
              <line x1="7" y1="7" x2="7.01" y2="7"/>
            </svg>
            {{ label.label }}
            <span class="nav-count">{{ label.count | number }}</span>
          </button>
        }
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Toolbar -->
      <div class="toolbar">
        <div class="search-box" [class.searching]="mbox.isSearching()">
          @if (mbox.isSearching()) {
            <span class="spinner search-spinner"></span>
          } @else {
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"/>
              <line x1="21" y1="21" x2="16.65" y2="16.65"/>
            </svg>
          }
          <input 
            #searchInput
            type="text" 
            placeholder="Search emails... (from:user subject:test date:2024)" 
            [value]="searchValue"
            (input)="onSearchInput(searchInput.value)">
          @if (searchValue) {
            <button class="btn-clear" (click)="onClearSearch()">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
            </button>
          }
        </div>
        @let resultsCount = mbox.searchResultsCount();
        @if (searchValue && resultsCount !== null) {
          <span class="search-results-count">
            @if (resultsCount > mbox.emails().length) {
              {{ mbox.emails().length }} of {{ resultsCount }} results
            } @else {
              {{ resultsCount }} results
            }
          </span>
        }
      </div>

      <!-- Content Area -->
      <div class="content-area">
        <!-- Email List -->
        <div class="email-list" [class.has-selection]="mbox.selectedEmail()">
          @if (mbox.searchQuery()) {
            <div class="list-header">
              Search results for "{{ mbox.searchQuery() }}" ({{ mbox.emails().length }} found)
            </div>
          }
          @if (mbox.selectedLabel()) {
            <div class="list-header">
              {{ mbox.selectedLabel() }} ({{ mbox.emails().length }} emails)
            </div>
          }

          @if ((mbox.loadingFile() || mbox.loadingEmails()) && mbox.emails().length === 0) {
            <div class="loading-state">
              <span class="spinner"></span>
              Loading emails...
            </div>
          }

          @for (email of mbox.emails(); track email.index) {
            <div 
              class="email-item" 
              [class.selected]="mbox.selectedEmail()?.index === email.index"
              [class.has-attachment]="email.has_attachments"
              role="button"
              tabindex="0"
              (click)="onEmailClick(email)"
              (keydown.enter)="onEmailClick(email)">
              <div class="email-sender">{{ formatSender(email) }}</div>
              <div class="email-subject">
                @if (email.has_attachments) {
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="attachment-icon">
                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
                  </svg>
                }
                {{ email.subject || '(No subject)' }}
              </div>
              <div class="email-date">{{ formatDate(email.date) }}</div>
              @if (email.labels.length > 0) {
                <div class="email-labels">
                  @for (label of email.labels.slice(0, 3); track label) {
                    <span class="label-tag">{{ label }}</span>
                  }
                  @if (email.labels.length > 3) {
                    <span class="label-more">+{{ email.labels.length - 3 }}</span>
                  }
                </div>
              }
            </div>
          }

          @if (!mbox.loadingFile() && !mbox.loadingEmails() && mbox.emails().length === 0) {
            <div class="empty-state">
              <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                <polyline points="22,6 12,13 2,6"/>
              </svg>
              <p>No emails found</p>
            </div>
          }
        </div>

        <!-- Email Detail -->
        @let email = mbox.selectedEmail();
        @if (email) {
          <div class="email-detail">
            <div class="detail-header">
              <button class="btn-back" (click)="onCloseEmail()">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="19" y1="12" x2="5" y2="12"/>
                  <polyline points="12 19 5 12 12 5"/>
                </svg>
                Back
              </button>
            </div>

            <div class="detail-content">
              <h2 class="detail-subject">{{ email.subject || '(No subject)' }}</h2>
              
              <div class="detail-meta">
                <div class="meta-row">
                  <span class="meta-label">From:</span>
                  <span class="meta-value">
                    @if (email.from_name) {
                      {{ email.from_name }} &lt;{{ email.from_address }}&gt;
                    } @else {
                      {{ email.from_address }}
                    }
                  </span>
                </div>
                @if (email.to.length > 0) {
                  <div class="meta-row">
                    <span class="meta-label">To:</span>
                    <span class="meta-value">
                      @for (to of email.to; track to.address; let last = $last) {
                        @if (to.name) {
                          {{ to.name }} &lt;{{ to.address }}&gt;
                        } @else {
                          {{ to.address }}
                        }
                        @if (!last) {, }
                      }
                    </span>
                  </div>
                }
                <div class="meta-row">
                  <span class="meta-label">Date:</span>
                  <span class="meta-value">{{ formatDate(email.date) }}</span>
                </div>
                @if (email.labels.length > 0) {
                  <div class="meta-row">
                    <span class="meta-label">Labels:</span>
                    <span class="meta-value labels">
                      @for (label of email.labels; track label) {
                        <span class="label-tag">{{ label }}</span>
                      }
                    </span>
                  </div>
                }
              </div>

              <!-- Attachments -->
              @let body = mbox.selectedEmailBody();
              @if (body && body.attachments.length > 0) {
                <div class="attachments-section">
                  <h3>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
                    </svg>
                    Attachments ({{ body.attachments.length }})
                  </h3>
                  <div class="attachments-list">
                    @for (attachment of body.attachments; track attachment.part_index) {
                      <button class="attachment-item" (click)="onDownloadAttachment(attachment)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                          <polyline points="14 2 14 8 20 8"/>
                        </svg>
                        <div class="attachment-info">
                          <span class="attachment-name">{{ attachment.filename }}</span>
                          <span class="attachment-size">{{ formatFileSize(attachment.size) }}</span>
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="download-icon">
                          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                          <polyline points="7 10 12 15 17 10"/>
                          <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                      </button>
                    }
                  </div>
                </div>
              }

              <!-- Email Body -->
              <div class="email-body">
                @if (mbox.loadingEmailBody() && !body) {
                  <div class="loading-state">
                    <span class="spinner"></span>
                    Loading email content...
                  </div>
                } @else if (body) {
                  @if (body.html) {
                    <iframe 
                      class="email-iframe"
                      [srcdoc]="body.html"
                      sandbox="allow-same-origin">
                    </iframe>
                  } @else if (body.text) {
                    <pre class="email-text">{{ body.text }}</pre>
                  } @else {
                    <div class="empty-body">
                      <p>No content available</p>
                    </div>
                  }
                } @else {
                  <div class="empty-body">
                    <p>No content available</p>
                  </div>
                }
              </div>
            </div>
          </div>
        }
      </div>
    </main>
  </div>
}

<!-- Error Toast -->
@if (mbox.error()) {
  <div class="error-toast" role="button" tabindex="0" (click)="onDismissError()" (keydown.enter)="onDismissError()">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="10"/>
      <line x1="12" y1="8" x2="12" y2="12"/>
      <line x1="12" y1="16" x2="12.01" y2="16"/>
    </svg>
    {{ mbox.error() }}
    <button class="btn-dismiss">Dismiss</button>
  </div>
}
