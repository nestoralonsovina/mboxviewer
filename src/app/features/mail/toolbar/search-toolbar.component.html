<div class="bg-white dark:bg-surface-900 border-b border-surface-200 dark:border-surface-800">
  <!-- Main search bar -->
  <div class="flex items-center gap-3 px-6 py-3">
    <div class="flex-1 flex items-center gap-3 px-4 py-2 bg-surface-100 dark:bg-surface-800 rounded-lg">
      @if (isSearching()) {
        <app-spinner [size]="16" />
      } @else {
        <app-icon name="search" [size]="16" class="text-surface-400 dark:text-surface-500 shrink-0" />
      }
      <input
        #searchInput
        type="text"
        class="flex-1 bg-transparent text-sm text-surface-900 dark:text-surface-50 placeholder:text-surface-400 dark:placeholder:text-surface-500 border-0 outline-0 ring-0 shadow-none p-0 m-0"
        style="border: none; outline: none; box-shadow: none;"
        placeholder="Search emails..."
        [value]="searchValue()"
        (input)="onSearchInput(searchInput.value)">
      @if (searchValue() || hasAdvancedFilters()) {
        <button 
          class="flex items-center justify-center w-5 h-5 text-surface-400 dark:text-surface-500 bg-surface-200 dark:bg-surface-700 border-none rounded-full cursor-pointer hover:bg-surface-300 dark:hover:bg-surface-600"
          (click)="onClearSearch()">
          <app-icon name="close" [size]="10" />
        </button>
      }
    </div>

    <!-- Advanced toggle button -->
    <button
      class="flex items-center gap-2 px-3 py-2 text-sm rounded-lg border transition-colors"
      [class]="advancedOpen() || hasAdvancedFilters()
        ? 'bg-accent/10 text-accent border-accent/30 hover:bg-accent/20'
        : 'bg-surface-100 dark:bg-surface-800 text-surface-600 dark:text-surface-400 border-transparent hover:bg-surface-200 dark:hover:bg-surface-700'"
      (click)="toggleAdvanced()">
      <app-icon name="sliders" [size]="14" />
      <span class="max-md:hidden">Filters</span>
      @if (activeFilterCount() > 0) {
        <span class="flex items-center justify-center w-5 h-5 text-xs font-medium bg-accent text-white rounded-full">
          {{ activeFilterCount() }}
        </span>
      }
      <app-icon 
        [name]="advancedOpen() ? 'chevron-up' : 'chevron-down'" 
        [size]="14" 
        class="max-md:hidden" />
    </button>

    <!-- Results count -->
    @let resultsCount = searchResultsCount();
    @if ((searchValue() || hasAdvancedFilters()) && resultsCount !== null) {
      <span class="text-sm text-surface-500 dark:text-surface-400 whitespace-nowrap tabular-nums">
        <span class="text-accent font-medium">{{ resultsCount > emailCount() ? emailCount() : resultsCount }}</span>
        @if (resultsCount > emailCount()) {
          of {{ resultsCount }}
        } results
      </span>
    }
  </div>

  <!-- Advanced search panel -->
  @if (advancedOpen()) {
    <div class="px-6 pb-4 pt-1 border-t border-surface-100 dark:border-surface-800">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- From field -->
        <div class="flex flex-col gap-1.5">
          <label class="text-xs font-medium text-surface-500 dark:text-surface-400">From</label>
          <input
            #fromInput
            type="text"
            class="px-3 py-2 text-sm bg-surface-100 dark:bg-surface-800 text-surface-900 dark:text-surface-50 placeholder:text-surface-300 dark:placeholder:text-surface-600 rounded-lg border border-surface-200 dark:border-surface-700 focus:border-accent focus:ring-1 focus:ring-accent outline-none"
            placeholder="sender@example.com"
            [value]="searchFields().from"
            (input)="onFieldChange('from', fromInput.value)">
        </div>

        <!-- To field -->
        <div class="flex flex-col gap-1.5">
          <label class="text-xs font-medium text-surface-500 dark:text-surface-400">To</label>
          <input
            #toInput
            type="text"
            class="px-3 py-2 text-sm bg-surface-100 dark:bg-surface-800 text-surface-900 dark:text-surface-50 placeholder:text-surface-300 dark:placeholder:text-surface-600 rounded-lg border border-surface-200 dark:border-surface-700 focus:border-accent focus:ring-1 focus:ring-accent outline-none"
            placeholder="recipient@example.com"
            [value]="searchFields().to"
            (input)="onFieldChange('to', toInput.value)">
        </div>

        <!-- Subject field -->
        <div class="flex flex-col gap-1.5">
          <label class="text-xs font-medium text-surface-500 dark:text-surface-400">Subject</label>
          <input
            #subjectInput
            type="text"
            class="px-3 py-2 text-sm bg-surface-100 dark:bg-surface-800 text-surface-900 dark:text-surface-50 placeholder:text-surface-300 dark:placeholder:text-surface-600 rounded-lg border border-surface-200 dark:border-surface-700 focus:border-accent focus:ring-1 focus:ring-accent outline-none"
            placeholder="Meeting notes"
            [value]="searchFields().subject"
            (input)="onFieldChange('subject', subjectInput.value)">
        </div>

        <!-- Body field (requires other filters first) -->
        <div class="flex flex-col gap-1.5">
          <label class="text-xs font-medium text-surface-500 dark:text-surface-400">
            Content
            @if (!canSearchContent()) {
              <span class="font-normal text-surface-400 dark:text-surface-500">(add a filter first)</span>
            }
          </label>
          <input
            #bodyInput
            type="text"
            class="px-3 py-2 text-sm rounded-lg border outline-none transition-colors"
            [class]="canSearchContent()
              ? 'bg-surface-100 dark:bg-surface-800 text-surface-900 dark:text-surface-50 placeholder:text-surface-300 dark:placeholder:text-surface-600 border-surface-200 dark:border-surface-700 focus:border-accent focus:ring-1 focus:ring-accent'
              : 'bg-surface-50 dark:bg-surface-900 text-surface-400 dark:text-surface-600 border-surface-100 dark:border-surface-800 cursor-not-allowed'"
            placeholder="Search in email body..."
            [value]="searchFields().body"
            [disabled]="!canSearchContent()"
            (input)="onFieldChange('body', bodyInput.value)">
        </div>
      </div>

      <!-- Checkbox row -->
      <div class="flex items-center gap-6 mt-4">
        <label class="flex items-center gap-2 cursor-pointer select-none">
          <input
            #attachmentCheckbox
            type="checkbox"
            class="w-4 h-4 rounded border-surface-300 dark:border-surface-600 text-accent focus:ring-accent focus:ring-offset-0 bg-surface-100 dark:bg-surface-800"
            [checked]="searchFields().hasAttachment"
            (change)="onFieldChange('hasAttachment', attachmentCheckbox.checked)">
          <span class="text-sm text-surface-700 dark:text-surface-300">Has attachment</span>
        </label>
      </div>
    </div>
  }
</div>
